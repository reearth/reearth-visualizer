name: ci-server
on:
  workflow_call:

jobs:
  ci-server-lint:
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.event.head_commit.message, 'v')
    steps:
      - name: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Fetch base branch
        run: git fetch origin main
      - name: set up
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --new-from-rev=origin/main --timeout=10m
          working-directory: server
      - name: Run go generate
        run: |
          make generate
        working-directory: server
      - name: Check for changes in generated files
        run: |
          git diff --exit-code

  ci-server-unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Start MongoDB and Fake GCS for unit tests
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          echo "Waiting for MongoDB..."
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          echo "Waiting for Fake GCS Server..."
          timeout 30 bash -c 'until nc -z localhost 4443 2>/dev/null; do echo "Waiting for Fake GCS..."; sleep 2; done'
          echo "Verifying Fake GCS Server is working..."
          curl -s -f http://localhost:4443/storage/v1/b || echo "GCS health check failed (may be normal)"
          echo "MongoDB and Fake GCS are ready!"
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: reearth/reearth-accounts
          ref: feat/reearthx-to-reearth-accounts5
          path: reearth-accounts

      - name: Display reearth-accounts branch info
        run: |
          cd reearth-accounts
          echo "========================================="
          echo "=== REEARTH-ACCOUNTS BRANCH INFO ==="
          echo "========================================="
          echo "Repository: reearth/reearth-accounts"
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git log -1 --format='%H')"
          echo "Commit Message: $(git log -1 --format='%s')"
          echo "Commit Date: $(git log -1 --format='%ci')"
          echo "========================================="

      - name: Start reearth-accounts for unit tests
        run: |
          cd reearth-accounts/server
          cp .env.docker.example .env.docker
          echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          cd ..
          docker compose -f docker-compose.dev.yml up -d

          echo "Waiting for reearth-accounts to be ready..."
          for i in {1..30}; do
            if nc -z localhost 8090 2>/dev/null; then
              echo "reearth-accounts is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for reearth-accounts"
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1
              exit 1
            fi
            sleep 2
          done

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic -timeout 10m
        env:
          REEARTH_DB: mongodb://localhost
          REEARTH_ACCOUNTSAPI_HOST: http://localhost:8090
          REEARTH_ACCOUNTSAPI_TIMEOUT: 30
        working-directory: server

      - name: Send coverage report
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: server

  ci-server-e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Create reearth network and start services
        run: |
          echo "=== Creating reearth network by running docker-compose ==="
          docker compose -f docker-compose.dev.yml up --no-start
          echo "=== Starting reearth-visualizer services (mongo, gcs) ==="
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          echo "=== Docker networks ==="
          docker network ls
          echo "=== Verifying reearth network exists ==="
          docker network inspect reearth

      - name: Wait for MongoDB to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'

      - name: Initialize MongoDB replica set
        run: |
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: reearth/reearth-accounts
          ref: feat/reearthx-to-reearth-accounts5
          path: reearth-accounts

      - name: Display reearth-accounts branch info
        run: |
          cd reearth-accounts
          echo "========================================="
          echo "=== REEARTH-ACCOUNTS BRANCH INFO ==="
          echo "========================================="
          echo "Repository: reearth/reearth-accounts"
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git log -1 --format='%H')"
          echo "Commit Message: $(git log -1 --format='%s')"
          echo "Commit Date: $(git log -1 --format='%ci')"
          echo "========================================="

      - name: Configure and start reearth-accounts for E2E tests
        run: |
          cd reearth-accounts/server
          cp .env.docker.example .env.docker
          echo "" >> .env.docker
          echo "# E2E test configuration - using mock auth (no migration needed)" >> .env.docker
          echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          echo "REEARTH_AUTH_ISS=https://reearth.io" >> .env.docker
          echo "=== Contents of .env.docker after configuration ==="
          tail -10 .env.docker
          cd ..

          echo "=== Starting reearth-accounts services with mock auth ==="
          docker compose -f docker-compose.dev.yml up -d

          echo "=== Checking which networks reearth-accounts containers are connected to ==="
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"
          docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"

          echo "=== Manually connecting to reearth network if needed ==="
          if ! docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-accounts-dev not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-accounts-dev-1
          fi
          if ! docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-cerbos not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-cerbos-1
          fi

          echo "=== Waiting for reearth-accounts to start ==="
          sleep 10
          echo "=== Checking reearth-accounts logs ==="
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 | tail -30

      - name: Wait for reearth-accounts to be ready
        run: |
          echo "Waiting for reearth-accounts service to start..."
          for i in {1..30}; do
            if nc -z localhost 8090 2>/dev/null; then
              echo "reearth-accounts is ready on port 8090!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for reearth-accounts to be ready"
              echo "=== Container status ==="
              docker ps -a
              echo "=== reearth-accounts logs ==="
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
              echo "=== reearth-cerbos logs ==="
              docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
              exit 1
            fi
            echo "Waiting for reearth-accounts... ($i/30)"
            sleep 2
          done
          echo "reearth-accounts is ready!"
          echo "=== Verifying mock auth is enabled ==="
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 | grep -i "mock" || echo "Mock auth log not found"

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Build reearth-visualizer-dev container
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-visualizer-dev
          echo "=== Verifying network connectivity ==="
          docker network inspect reearth | grep -A 3 "reearth-accounts-reearth-accounts-dev-1" || echo "reearth-accounts not found in reearth network"
          docker network inspect reearth | grep -A 3 "reearth-visualizer-reearth-visualizer-dev-1" || echo "reearth-visualizer not found in reearth network"
          docker exec reearth-visualizer-reearth-visualizer-dev-1 ping -c 2 reearth-accounts-dev || echo "Cannot ping reearth-accounts-dev"

      - name: Wait for reearth-visualizer to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-visualizer-dev-1 echo "ready" 2>/dev/null; do echo "Waiting for reearth-visualizer..."; sleep 2; done'

      - name: Debug network and container information before e2e tests
        run: |
          echo "======================================"
          echo "=== ALL RUNNING CONTAINERS ==="
          echo "======================================"
          docker ps -a
          echo ""
          echo "======================================"
          echo "=== REEARTH NETWORK DETAILS ==="
          echo "======================================"
          docker network inspect reearth
          echo ""

      - name: Run e2e tests
        run: make e2e
        working-directory: server

      - name: Show reearth-accounts logs on failure
        if: failure()
        run: |
          echo "========================================"
          echo "=== REEARTH-ACCOUNTS FULL LOGS ==="
          echo "========================================"
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
