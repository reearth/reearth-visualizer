name: ci-server
on:
  workflow_call:

jobs:
  ci-server-lint:
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.event.head_commit.message, 'v')
    steps:
      - name: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Fetch base branch
        run: git fetch origin main
      - name: set up
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --new-from-rev=origin/main --timeout=10m
          working-directory: server
      - name: Run go generate
        run: |
          make generate
        working-directory: server
      - name: Check for changes in generated files
        run: |
          git diff --exit-code

  ci-server-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Create reearth network and start services
        run: |
          echo "=== Creating reearth network by running docker-compose ==="
          docker compose -f docker-compose.dev.yml up --no-start
          echo "=== Starting reearth-visualizer services (mongo, gcs) ==="
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          echo "=== Docker networks ==="
          docker network ls
          echo "=== Verifying reearth network exists ==="
          docker network inspect reearth

      - name: Wait for MongoDB to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'

      - name: Initialize MongoDB replica set
        run: |
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: reearth/reearth-accounts
          ref: feat/reearthx-to-reearth-accounts3
          path: reearth-accounts

      - name: Configure reearth-accounts for E2E tests
        run: |
          cd reearth-accounts/server
          echo "" >> .env.docker
          echo "# Mock Authentication for E2E tests" >> .env.docker
          echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          echo "RUN_MIGRATION=true" >> .env.docker
          cd ..
          echo "=== Verifying docker-compose.dev.yml network configuration ==="
          grep -A 2 "networks:" docker-compose.dev.yml || echo "No networks section found"

      - name: Run database migrations
        run: |
          cd reearth-accounts
          echo "=== Verifying reearth network before starting reearth-accounts ==="
          docker network inspect reearth || echo "reearth network not found!"
          echo "=== Starting reearth-accounts services ==="
          docker compose -f docker-compose.dev.yml up -d --force-recreate
          echo "=== Checking which networks reearth-accounts containers are connected to ==="
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"
          docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"
          echo "=== Manually connecting to reearth network if needed ==="
          if ! docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-accounts-dev not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-accounts-dev-1
          fi
          if ! docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-cerbos not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-cerbos-1
          fi
          echo "=== Final network check ==="
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}'
          echo "Waiting for migrations to complete..."
          sleep 15
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 | tail -20

      - name: Remove migration flag and restart
        run: |
          cd reearth-accounts/server
          sed -i '/RUN_MIGRATION=true/d' .env.docker
          cd ..
          docker compose -f docker-compose.dev.yml restart reearth-accounts-dev
          docker ps -a

      - name: Wait for reearth-accounts to be ready
        run: |
          echo "Waiting for reearth-accounts service to start..."
          for i in {1..30}; do
            if nc -z localhost 8090 2>/dev/null; then
              echo "reearth-accounts is ready on port 8090!"
              curl -s http://localhost:8090/health || echo "Health check endpoint not available"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for reearth-accounts to be ready"
              echo "=== Container status ==="
              docker ps -a
              echo "=== reearth-accounts logs ==="
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
              echo "=== reearth-cerbos logs ==="
              docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
              exit 1
            fi
            echo "Waiting for reearth-accounts... ($i/30)"
            sleep 2
          done
          echo "Additional wait for stability..."
          sleep 5

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic -timeout 10m
        env:
          REEARTH_DB: mongodb://localhost
          REEARTH_ACCOUNTSAPI_HOST: http://localhost:8090
          REEARTH_ACCOUNTSAPI_TIMEOUT: 30
        working-directory: server

      - name: Build reearth-visualizer-dev container
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-visualizer-dev
          echo "=== Verifying network connectivity ==="
          docker network inspect reearth | grep -A 3 "reearth-accounts-reearth-accounts-dev-1" || echo "reearth-accounts not found in reearth network"
          docker network inspect reearth | grep -A 3 "reearth-visualizer-reearth-visualizer-dev-1" || echo "reearth-visualizer not found in reearth network"
          docker exec reearth-visualizer-reearth-visualizer-dev-1 ping -c 2 reearth-accounts-dev || echo "Cannot ping reearth-accounts-dev"

      - name: Wait for reearth-visualizer to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-visualizer-dev-1 echo "ready" 2>/dev/null; do echo "Waiting for reearth-visualizer..."; sleep 2; done'

      - name: Run e2e tests
        run: make e2e
        working-directory: server

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== reearth-visualizer logs ==="
          docker logs reearth-visualizer-reearth-visualizer-dev-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== reearth-accounts logs ==="
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== reearth-cerbos logs ==="
          docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== MongoDB logs ==="
          docker logs reearth-visualizer-reearth-mongo-1 2>&1 || echo "Container not found"

      - name: Send coverage report
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: server
