name: ci-server
on:
  workflow_call:

jobs:
  ci-server-lint:
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.event.head_commit.message, 'v')
    steps:
      - name: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Fetch base branch
        run: git fetch origin main
      - name: set up
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --new-from-rev=origin/main --timeout=10m
          working-directory: server
      - name: Run go generate
        run: |
          make generate
        working-directory: server
      - name: Check for changes in generated files
        run: |
          git diff --exit-code

  ci-server-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Start reearth-visualizer services (mongo, gcs)
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          docker network ls

      - name: Wait for MongoDB to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'

      - name: Initialize MongoDB replica set
        run: |
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: reearth/reearth-accounts
          path: reearth-accounts

      - name: Start reearth-accounts services
        run: |
          cd reearth-accounts
          docker compose -f docker-compose.dev.yml up -d
          docker ps -a

      - name: Wait for reearth-accounts to be ready
        run: |
          echo "Waiting for reearth-accounts container to start..."
          for i in {1..30}; do
            if docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{.State.Status}}' 2>/dev/null | grep -q "running"; then
              echo "Container is running, checking port 8090..."
              if nc -z localhost 8090 2>/dev/null; then
                echo "reearth-accounts is ready on port 8090!"
                break
              fi
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for reearth-accounts to be ready"
              echo "=== Container status ==="
              docker ps -a
              echo "=== reearth-accounts logs ==="
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
              echo "=== reearth-cerbos logs ==="
              docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
              exit 1
            fi
            echo "Waiting for reearth-accounts... ($i/30)"
            sleep 2
          done
          echo "Additional wait for stability..."
          sleep 5

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic -timeout 10m
        env:
          REEARTH_DB: mongodb://localhost
          REEARTH_ACCOUNTSAPI_HOST: http://localhost:8090
          REEARTH_ACCOUNTSAPI_TIMEOUT: 30
        working-directory: server

      - name: Build reearth-visualizer-dev container
        run: docker compose -f docker-compose.dev.yml up -d reearth-visualizer-dev

      - name: Wait for reearth-visualizer to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-visualizer-dev-1 echo "ready" 2>/dev/null; do echo "Waiting for reearth-visualizer..."; sleep 2; done'

      - name: Run e2e tests
        run: docker exec reearth-visualizer-reearth-visualizer-dev-1 sh -c "make e2e-docker"
        working-directory: server

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== reearth-visualizer logs ==="
          docker logs reearth-visualizer-reearth-visualizer-dev-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== reearth-accounts logs ==="
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== reearth-cerbos logs ==="
          docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
          echo ""
          echo "=== MongoDB logs ==="
          docker logs reearth-visualizer-reearth-mongo-1 2>&1 || echo "Container not found"

      - name: Send coverage report
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: server
