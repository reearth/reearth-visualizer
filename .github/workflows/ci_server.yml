name: ci-server
on:
  workflow_call:

jobs:
  ci-server-lint:
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.event.head_commit.message, 'v')
    steps:
      - name: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Fetch base branch
        run: git fetch origin main
      - name: set up
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --new-from-rev=origin/main --timeout=10m
          working-directory: server
      - name: Run go generate
        run: |
          make generate
        working-directory: server
      - name: Check for changes in generated files
        run: |
          git diff --exit-code

  ci-server-unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Start MongoDB and GCS for unit tests
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          sleep 5
          echo "Initializing GCS bucket..."
          curl -X POST -H "Content-Type: application/json" -d '{"name": "test-bucket"}' http://localhost:4443/storage/v1/b || echo "Bucket creation failed"

      - name: Checkout reearth-accounts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: reearth/reearth-accounts
          ref: feat/reearthx-to-reearth-accounts3
          path: reearth-accounts

      - name: Start reearth-accounts for unit tests
        run: |
          cd reearth-accounts/server
          echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          cd ..
          docker compose -f docker-compose.dev.yml up -d

          echo "Waiting for reearth-accounts to be ready..."
          for i in {1..30}; do
            if nc -z localhost 8090 2>/dev/null; then
              echo "reearth-accounts is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for reearth-accounts"
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1
              exit 1
            fi
            sleep 2
          done

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic -timeout 10m
        env:
          REEARTH_DB: mongodb://localhost
          REEARTH_ACCOUNTSAPI_HOST: http://localhost:8090
          REEARTH_ACCOUNTSAPI_TIMEOUT: 30
        working-directory: server

      - name: Send coverage report
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: server

  ci-server-e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Create reearth network and start services
        run: |
          echo "=== Creating reearth network by running docker-compose ==="
          docker compose -f docker-compose.dev.yml up --no-start
          echo "=== Starting reearth-visualizer services (mongo, gcs) ==="
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          echo "=== Docker networks ==="
          docker network ls
          echo "=== Verifying reearth network exists ==="
          docker network inspect reearth

      - name: Wait for MongoDB to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do echo "Waiting for MongoDB..."; sleep 2; done'

      - name: Initialize MongoDB replica set
        run: |
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || echo "Replica set already initialized"
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: reearth/reearth-accounts
          ref: feat/reearthx-to-reearth-accounts3
          path: reearth-accounts

      - name: Configure reearth-accounts for E2E tests
        run: |
          cd reearth-accounts/server
          echo "" >> .env.docker
          echo "# E2E test configuration" >> .env.docker
          echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          echo "REEARTH_AUTH_ISS=https://reearth.io" >> .env.docker
          echo "RUN_MIGRATION=true" >> .env.docker
          echo "=== Contents of .env.docker after configuration ==="
          tail -10 .env.docker
          cd ..
          echo "=== Verifying docker-compose.dev.yml network configuration ==="
          grep -A 2 "networks:" docker-compose.dev.yml || echo "No networks section found"

      - name: Run database migrations
        run: |
          cd reearth-accounts
          echo "=== Verifying reearth network before starting reearth-accounts ==="
          docker network inspect reearth || echo "reearth network not found!"
          echo "=== Starting reearth-accounts services ==="
          docker compose -f docker-compose.dev.yml up -d --force-recreate
          echo "=== Checking which networks reearth-accounts containers are connected to ==="
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"
          docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "Container not found"
          echo "=== Manually connecting to reearth network if needed ==="
          if ! docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-accounts-dev not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-accounts-dev-1
          fi
          if ! docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth"; then
            echo "reearth-cerbos not in reearth network, connecting..."
            docker network connect reearth reearth-accounts-reearth-cerbos-1
          fi
          echo "=== Final network check ==="
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}'
          echo "Waiting for migrations to complete..."
          sleep 15
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 | tail -20

      - name: Recreate .env.docker without RUN_MIGRATION
        run: |
          cd reearth-accounts/server
          echo "=== Creating new .env.docker with only REEARTH_MOCK_AUTH ==="
          cp .env.docker .env.docker.backup
          sed -i '/RUN_MIGRATION=true/d' .env.docker
          # Ensure REEARTH_MOCK_AUTH is set and not commented
          if ! grep -q "^REEARTH_MOCK_AUTH=true" .env.docker; then
            echo "REEARTH_MOCK_AUTH=true" >> .env.docker
          fi
          echo "=== Final .env.docker contents ==="
          cat .env.docker
          cd ..
          echo "=== Stopping and removing reearth-accounts-dev ==="
          docker compose -f docker-compose.dev.yml stop reearth-accounts-dev
          docker compose -f docker-compose.dev.yml rm -f reearth-accounts-dev
          echo "=== Starting reearth-accounts-dev ==="
          docker compose -f docker-compose.dev.yml up -d reearth-accounts-dev
          echo "=== Waiting for container to fully start ==="
          sleep 5
          echo "=== Checking REEARTH_MOCK_AUTH inside container ==="
          docker exec reearth-accounts-reearth-accounts-dev-1 sh -c 'echo "REEARTH_MOCK_AUTH=${REEARTH_MOCK_AUTH:-NOT_SET}"'
          docker exec reearth-accounts-reearth-accounts-dev-1 env | grep -E "REEARTH_MOCK|MOCK" || echo "No MOCK env vars found"
          echo "=== Checking reearth-accounts-dev logs after restart ==="
          sleep 5
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 | tail -50

      - name: Wait for reearth-accounts to be ready
        run: |
          echo "Waiting for reearth-accounts service to start..."
          for i in {1..30}; do
            if nc -z localhost 8090 2>/dev/null; then
              echo "Port 8090 is open, checking HTTP endpoint..."
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for port 8090 to open"
              echo "=== Container status ==="
              docker ps -a
              echo "=== reearth-accounts logs (full) ==="
              docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
              echo "=== reearth-cerbos logs ==="
              docker logs reearth-accounts-reearth-cerbos-1 2>&1 || echo "Container not found"
              exit 1
            fi
            echo "Waiting for port 8090... ($i/30)"
            sleep 2
          done

          echo "Port is open, waiting for HTTP server to be ready..."
          for i in {1..30}; do
            if curl -sf http://localhost:8090/api/graphql -X POST -H "Content-Type: application/json" -d '{"query":"{ __typename }"}' >/dev/null 2>&1; then
              echo "✓ reearth-accounts GraphQL API is responding!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Timeout waiting for reearth-accounts API to respond"
              echo "=== Checking if process is listening inside container ==="
              docker exec reearth-accounts-reearth-accounts-dev-1 netstat -tlnp 2>/dev/null | grep 8090 || echo "Port 8090 not listening"
              echo "=== Full reearth-accounts logs (last 100 lines) ==="
              docker logs --tail 100 reearth-accounts-reearth-accounts-dev-1 2>&1
              exit 1
            fi
            echo "Waiting for API to respond... ($i/30)"
            sleep 2
          done

          echo "=== Verifying REEARTH_MOCK_AUTH ==="
          docker exec reearth-accounts-reearth-accounts-dev-1 sh -c 'echo "REEARTH_MOCK_AUTH=$REEARTH_MOCK_AUTH"'

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Build reearth-visualizer-dev container
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-visualizer-dev
          echo "=== Verifying network connectivity ==="
          docker network inspect reearth | grep -A 3 "reearth-accounts-reearth-accounts-dev-1" || echo "reearth-accounts not found in reearth network"
          docker network inspect reearth | grep -A 3 "reearth-visualizer-reearth-visualizer-dev-1" || echo "reearth-visualizer not found in reearth network"
          docker exec reearth-visualizer-reearth-visualizer-dev-1 ping -c 2 reearth-accounts-dev || echo "Cannot ping reearth-accounts-dev"

      - name: Wait for reearth-visualizer to be ready
        run: |
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-visualizer-dev-1 echo "ready" 2>/dev/null; do echo "Waiting for reearth-visualizer..."; sleep 2; done'
          echo "Container is accessible, waiting for application to start..."
          sleep 10
          docker logs reearth-visualizer-reearth-visualizer-dev-1 2>&1 | tail -20

      - name: Verify connectivity before e2e tests
        run: |
          echo "=== Testing connectivity from visualizer to accounts API ==="
          for i in {1..10}; do
            if docker exec reearth-visualizer-reearth-visualizer-dev-1 sh -c "curl -sf http://reearth-accounts-dev:8090/api/graphql -X POST -H 'Content-Type: application/json' -d '{\"query\":\"{ __typename }\"}'" >/dev/null 2>&1; then
              echo "✓ GraphQL API connection successful on attempt $i"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "✗ Connection failed after 10 attempts"
              echo "=== Testing direct connection from host ==="
              curl -sf http://localhost:8090/api/graphql -X POST -H "Content-Type: application/json" -d '{"query":"{ __typename }"}' || echo "Direct connection also failed"
              echo ""
              echo "=== Network configuration ==="
              docker exec reearth-visualizer-reearth-visualizer-dev-1 cat /etc/resolv.conf || echo "Cannot read resolv.conf"
              echo ""
              echo "=== reearth-accounts logs ==="
              docker logs --tail 50 reearth-accounts-reearth-accounts-dev-1 2>&1
              exit 1
            fi
            echo "Connection attempt $i failed, retrying..."
            sleep 2
          done
          echo "✓ All connectivity checks passed"

      - name: Run e2e tests
        run: |
          set +e
          make e2e > e2e_output.log 2>&1
          EXIT_CODE=$?
          echo "=== E2E Test Results ==="
          grep -E "FAIL|PASS|---|^FAIL$" e2e_output.log || cat e2e_output.log
          exit $EXIT_CODE
        working-directory: server

      - name: Show reearth-accounts logs on failure
        if: failure()
        run: |
          echo "========================================"
          echo "=== REEARTH-ACCOUNTS FULL LOGS ==="
          echo "========================================"
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || echo "Container not found"
