name: ci-server
on:
  workflow_call:

jobs:
  ci-server-lint:
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.event.head_commit.message, 'v')
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Fetch base branch
        run: git fetch origin main
      - name: set up
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --new-from-rev=origin/main --timeout=10m
          working-directory: server
      - name: Run go generate
        run: |
          make generate
        working-directory: server
      - name: Check for changes in generated files
        run: |
          git diff --exit-code

  ci-server-unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Start MongoDB and Fake GCS
        run: |
          docker run -d --name fake-gcs-server \
            -p 4443:4443 \
            -v /tmp/gcs:/storage \
            fsouza/fake-gcs-server:1.52.1 \
            -scheme http
      - name: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: set up
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic -timeout 10m
        env:
          REEARTH_DB: mongodb://localhost
          REEARTH_ACCOUNTSAPI_HOST: http://localhost:8090
          REEARTH_ACCOUNTSAPI_TIMEOUT: 30
        working-directory: server

      - name: Send coverage report
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: server

  ci-server-e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout reearth-visualizer
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup .env.docker for reearth-visualizer
        run: |
          cd server
          cp .env.docker.example .env.docker

      - name: Create reearth network and start services
        run: |
          docker compose -f docker-compose.dev.yml up --no-start
          docker compose -f docker-compose.dev.yml up -d reearth-mongo reearth-gcs
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "db.adminCommand({ ping: 1 })" 2>/dev/null; do sleep 2; done'
          docker exec reearth-visualizer-reearth-mongo-1 mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'reearth-mongo:27017'}]})" || true
          sleep 5

      - name: Checkout reearth-accounts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: reearth/reearth-accounts
          ref: main
          path: reearth-accounts

      - name: Start reearth-accounts
        run: |
          cd reearth-accounts/server
          cp .env.docker.example .env.docker
          sed -i 's/REEARTH_MOCK_AUTH=false/REEARTH_MOCK_AUTH=true/' .env.docker
          echo "REEARTH_AUTH_ISS=https://reearth.io" >> .env.docker
          cd ..
          docker compose -f docker-compose.dev.yml up -d
          docker inspect reearth-accounts-reearth-accounts-dev-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth" || docker network connect reearth reearth-accounts-reearth-accounts-dev-1
          docker inspect reearth-accounts-reearth-cerbos-1 --format='{{range $net, $config := .NetworkSettings.Networks}}{{$net}} {{end}}' | grep -q "reearth" || docker network connect reearth reearth-accounts-reearth-cerbos-1
          sleep 10
          timeout 60 bash -c 'until nc -z localhost 8090 2>/dev/null; do sleep 2; done'

      - name: set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: server/go.mod
          cache-dependency-path: server/go.sum

      - name: Start reearth-visualizer
        run: |
          docker compose -f docker-compose.dev.yml up -d reearth-visualizer-dev
          timeout 60 bash -c 'until docker exec reearth-visualizer-reearth-visualizer-dev-1 echo "ready" 2>/dev/null; do sleep 2; done'

      - name: Run e2e tests
        run: make e2e
        working-directory: server

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== reearth-accounts logs ==="
          docker logs reearth-accounts-reearth-accounts-dev-1 2>&1 || true
          echo "=== reearth-visualizer logs ==="
          docker logs reearth-visualizer-reearth-visualizer-dev-1 2>&1 || true
